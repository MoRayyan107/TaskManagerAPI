<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header class="top-bar">
    <h2>Welcome To Your Task Manager</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div class="filters">
    <input type="text" id="searchInput" placeholder="ðŸ” Search tasks..." oninput="fetchTasks()">
    <select id="sortSelect" onchange="fetchTasks()">
        <option value="">Sort By</option>
        <option value="priority">Priority</option>
        <option value="completed">Completion Status</option>
    </select>
</div>

<div class="legend">
    <span><span class="circle high"></span> High</span>
    <span><span class="circle medium"></span> Medium</span>
    <span><span class="circle low"></span> Low</span>
</div>


<h3 class="section-header">Active Tasks</h3>
<div id="activeTasks" class="task-grid"></div>

<h3 class="section-header">Completed Tasks</h3>
<div id="completedTasks" class="task-grid"></div>

<div id="toast"></div>

<script>
    async function fetchTasks() {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "/login.html";
            return;
        }

        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const sortBy = document.getElementById("sortSelect").value;
        let url = "/tasks";

        if (sortBy === "priority" || sortBy === "completed") {
            url = `/tasks/sorted?sort=${sortBy}`;
        }

        const res = await fetch(url, {
            headers: { "Authorization": "Bearer " + token }
        });

        const active = document.getElementById("activeTasks");
        const completed = document.getElementById("completedTasks");
        active.innerHTML = "";
        completed.innerHTML = "";

        if (!res.ok) {
            alert("Error fetching tasks");
            return;
        }

        let tasks = await res.json();
        tasks = tasks.filter(task =>
            task.title.toLowerCase().includes(searchValue) ||
            task.description.toLowerCase().includes(searchValue) ||
            task.priority.toLowerCase().includes(searchValue)
        );

        tasks.forEach(task => {
            const card = document.createElement("div");
            card.classList.add("task-card");

            const content = document.createElement("div");
            content.classList.add("task-main");

            const title = document.createElement("h4");
            title.textContent = task.title;

            const desc = document.createElement("p");
            desc.textContent = task.description;

            content.appendChild(title);
            content.appendChild(desc);

            const actions = document.createElement("div");
            actions.classList.add("task-actions");

            const statusBtn = document.createElement("button");
            statusBtn.textContent = task.completed ? "Mark Incomplete" : "Mark Complete";
            statusBtn.onclick = () => updateTask(task.id, {
                title: task.title,
                description: task.description,
                priority: task.priority,
                completed: !task.completed
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = () => deleteTask(task.id);

            actions.appendChild(statusBtn);
            actions.appendChild(deleteBtn);

            const footer = document.createElement("div");
            footer.classList.add("priority-bar");
            footer.classList.add(task.priority.toLowerCase());

            card.appendChild(content);
            card.appendChild(actions);
            card.appendChild(footer);

            (task.completed ? completed : active).appendChild(card);
        });
    }

    function updateTask(id, data) {
        const token = localStorage.getItem("token");
        fetch(`/tasks/update/${id}`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        }).then(fetchTasks);
    }

    function deleteTask(id) {
        const token = localStorage.getItem("token");
        fetch(`/tasks/delete/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        }).then(fetchTasks);
    }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
    }

    fetchTasks();
</script>
</body>
</html>
